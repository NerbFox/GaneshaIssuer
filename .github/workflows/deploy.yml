name: Deploy GaneshaIssuer to VPS

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: DEV

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy Frontend to Development Server
        uses: appleboy/ssh-action@master
        with:
          # Bagian ini tetap sama, pakai secret yang sudah ada
          host: ${{ secrets.VPS_HOST_DEV }}
          username: ${{ secrets.VPS_USER_DEV }}
          key: ${{ secrets.VPS_SSH_KEY_DEV }}

          # Bagian script disesuaikan untuk proyek Next.js
          script: |
            # Masuk ke direktori frontend yang baru
            cd /www/ganeshaissuer

            # --- PERUBAHAN PENTING DIMULAI DI SINI ---
            echo "ğŸ”§ Ensuring correct Git remote URL for SSH alias..."
            # Atur URL remote agar menggunakan alias SSH yang benar
            git remote set-url origin git@github.com-ganeshaissuer:NerbFox/GaneshaIssuer.git

            echo "ğŸ“¦ Pulling latest code from dev branch..."
            # Configure git to use rebase strategy for pulls
            git config pull.rebase false

            # Reset package-lock.json jika ada konflik
            git checkout HEAD -- package-lock.json 2>/dev/null || true

            # Stash any local changes
            git stash

            # Fetch latest changes
            git fetch origin dev

            # Hard reset to match remote (force sync)
            git reset --hard origin/dev

            # Pop stashed changes jika ada (tapi abaikan error)
            git stash pop 2>/dev/null || true
            # --- PERUBAHAN PENTING SELESAI ---

            echo "ğŸ“ Creating .env file from GitHub secrets..."
            # Buat file .env dari secrets GitHub
            # File ini akan di-copy ke dalam Docker image saat build
            echo "${{ secrets.ENTIRE_ENV_FILE_STAGING }}" > .env

            echo "ğŸ”¨ Building Docker image (this may take a while)..."
            # Build image baru dengan no-cache untuk memastikan update
            # .env file akan otomatis di-copy ke dalam build context
            docker compose build --no-cache

            # Cek apakah build berhasil
            if [ $? -ne 0 ]; then
              echo "âŒ Docker build failed! Stopping deployment."
              exit 1
            fi

            echo "â¹ï¸  Stopping old containers..."
            # Hentikan container lama
            docker compose down

            echo "ğŸ¬ Starting new containers..."
            # Jalankan container baru di background
            docker compose up -d

            # Cek apakah container berjalan
            if [ $? -ne 0 ]; then
              echo "âŒ Failed to start containers! Rolling back..."
              docker compose down
              exit 1
            fi

            echo "ğŸ§¹ Cleaning up old Docker images..."
            # Hapus image yang tidak terpakai untuk hemat space
            docker image prune -af

            echo "âœ… Deployment completed successfully!"

            # Optional: Tampilkan status container
            echo "ğŸ“Š Container status:"
            docker compose ps
