name: Deploy GaneshaIssuer Frontend to VPS (Production)

on:
  push:
    branches:
      - master
  workflow_dispatch: # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: PROD

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy to Production Server
        if: github.ref == 'refs/heads/master'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST_PROD }}
          username: ${{ secrets.VPS_USER_PROD }}
          key: ${{ secrets.VPS_SSH_KEY_PROD }}
          script: |
            echo "ğŸš€ Starting deployment to production..."

            # Pindah ke direktori aplikasi
            cd /var/www/fe-ganeshadcert-prod

            # --- PERUBAHAN PENTING DIMULAI DI SINI ---
            echo "ğŸ”§ Ensuring correct Git remote URL for SSH alias..."
            # Atur URL remote agar menggunakan alias SSH yang benar
            git remote set-url origin git@github.com-ganeshaissuer:NerbFox/GaneshaIssuer.git

            echo "ğŸ“¦ Pulling latest code from master branch..."
            # Ambil source code terbaru dari branch master
            git pull origin master
            # --- PERUBAHAN PENTING SELESAI ---

            echo "ğŸ“ Creating .env file from GitHub secrets..."
            # Buat file .env dari secrets GitHub
            # File ini akan di-copy ke dalam Docker image saat build
            echo "${{ secrets.ENTIRE_ENV_FILE }}" > .env

            echo "ğŸ”¨ Building Docker image (this may take a while)..."
            # Build image baru dengan no-cache untuk memastikan update
            # .env file akan otomatis di-copy ke dalam build context
            docker compose build --no-cache

            # Cek apakah build berhasil
            if [ $? -ne 0 ]; then
              echo "âŒ Docker build failed! Stopping deployment."
              exit 1
            fi

            echo "â¹ï¸  Stopping old containers..."
            # Hentikan container lama
            docker compose down

            echo "ğŸ¬ Starting new containers..."
            # Jalankan container baru di background
            docker compose up -d

            # Cek apakah container berjalan
            if [ $? -ne 0 ]; then
              echo "âŒ Failed to start containers! Rolling back..."
              docker compose down
              exit 1
            fi

            echo "ğŸ§¹ Cleaning up old Docker images..."
            # Hapus image yang tidak terpakai untuk hemat space
            docker image prune -af

            echo "âœ… Deployment completed successfully!"

            # Optional: Tampilkan status container
            echo "ğŸ“Š Container status:"
            docker compose ps
